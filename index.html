<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>jeuStations</title>
    <style type="text/css" media="screen">
        canvas, img { display:block; margin:1em auto; border:1px solid black; }
        canvas { background:url('content/carte.jpg') }
    </style>
</head>
<body>

<canvas id="carte_ratp" width="810" height="808">
    L'objet Canvas ne marche pas chez vous, veuillez utiliser un navigateur r√©cent.
</canvas>

<h2>Quelle est cette station ?</h2>
<input type="text" name="subject" id="subject"  />
<button id="submit">Valider</button>
<div id="result" style="margin-left: 3px;width: 150px;border-left: solid black 1px;border-right: solid black 1px;border-bottom: solid black 1px;"  ></div>

<script>
    var canvas = document.getElementById('carte_ratp');
    var context = canvas.getContext('2d');
    var autoload = document.getElementById('subject');
    var submit = document.getElementById('submit');
    var stations;

    var res = document.getElementById("result");
    var station;
    window.onload = function()
    {
        request(readData);

        autoload.onkeyup = function(){
            refreshAC(stations);
        }

        submit.onclick = function(){
            var userStation = autoload.dataset.id;
            console.log('station: '+station)
            console.log('station id: '+station.id)
            console.log('userStation: ' + userStation)
            if(userStation == station.id){
                console.log('On lui rajoute un point');
            }else{
                console.log('on indique le fail');
            }
            clearCanvas(context, canvas);
            clearInput(autoload);
            station = drawRandomCircle(stations, canvas);
        }
    }

    /**
     *
     */
    function request(callback){
        var xhr = getXMLHttpRequest();
        var url = "ChargementStations.php";
        var method = "GET";
        var sync = true;

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && (xhr.status == 200 || xhr.status == 0)) {
                callback(xhr.responseText);
            }
        };

        xhr.open(method, url, sync);
        xhr.send(null);
    }

    function clearInput(input){
        input.value = '';
    }

    /**
     * @param rawData
     */
    function readData(rawData){
        stations = JSON.parse(rawData).filter(isMetro);
        station = drawRandomCircle(stations);
    }

    /**
     * @param stations
     * @param canvas
     * @return station
     */
    function drawRandomCircle(stations, canvas){
        var station = stations[random(stations)];
        drawCircle(canvas, station.x, station.y, context);
        return station;
    }

    function clearCanvas(context, canvas){
        context.clearRect(0, 0, canvas.width, canvas.height);
    }


    function isMetro(station){
        return (station.type == 'metro');
    }

    /**
     * Charge l'objet HttpRequest
     */

    function getXMLHttpRequest() {
        var xhr = null;
        if (window.XMLHttpRequest || window.ActiveXObject) {
            if (window.ActiveXObject) {
                try {
                    xhr = new ActiveXObject("Msxml2.XMLHTTP");
                } catch(e) {
                    xhr = new ActiveXObject("Microsoft.XMLHTTP");
                }
            } else {
                xhr = new XMLHttpRequest();
            }
        } else {
            alert("Votre navigateur ne supporte pas l'objet XMLHTTPRequest...");
            return null;
        }

        return xhr;
    }

    /**
     * Draw a circle at a specific location within the canvas
     * @param canvas
     * @param x
     * @param y
     * @param context
     */
    function drawCircle(canvas, x, y, context){
        var RESIZE = 10;
        var RADIUS = 4;

        context.beginPath();
        context.arc(x/RESIZE, y/RESIZE, RADIUS, 0, 2 * Math.PI, false);
        context.fillStyle = 'red';
        context.fill();
        context.stroke();
    }

    /**
     *
     */
    function drawText(name, x, y, context){
        var RESIZE = 10;
        context.font = "bold 8px Arial";
        context.fillStyle = 'black';
        context.fillText(name, x/RESIZE, y/RESIZE);
    }

    /**
     * Return a random number between 0 and the number of object inside tab
     * @param tab
     * @returns {number}
     */
    function random( tab )
    {
        return Math.floor(tab.length * Math.random());
    }

    /**
     * Refresh the autocomplete
     */
    function refreshAC(stations)
    {
        try{
            var sub = document.getElementById("subject");
            var val = sub.value;

            res.innerHTML = "";
            if( val != "" )
            {
                stations.forEach(function(station){
                    var rgxp = new RegExp('^'+val, "g");
                    if(station.name.match(rgxp) != null && station.name.match(rgxp).length){
                        res.innerHTML += "<div id="+station.id+" onmouseout='selectionPointer2(this)' onmouseover='selectionPointer(this)' onclick='selectionClique(this)'>"+station.name+"</div>";
                    }
                });
            }
        }
        catch (err){
            console.log(err);
        }

    }

    function selectionPointer2( element )
    {
        element.style.backgroundColor = "white";
    }
    function selectionPointer( element )
    {
        element.style.backgroundColor = "green";
    }
    function selectionClique( element )
    {
        var sub = document.getElementById("subject");
        sub.dataset.id = element.id;
        sub.value = element.innerHTML;
        res.innerHTML = "";
    }

</script>
</body>
</html>